version: '1.0'

mode: parallel

stages:
- prepare
- test
- push

steps:
  main_clone:
    stage: prepare
    type: git-clone
    repo: open-integration/core
    git: cf_github
    revision: ${{CF_REVISION}}

  version:
    stage: prepare
    image: codefresh/cli
    commands:
    - cf_export VERSION=$(cat VERSION)
    - cf_export LATEST_VERSION=$(git show HEAD~1:VERSION)
    when: &clone
      steps:
      - name: main_clone
        on:
        - success

  git-tag:
    stage: push
    title: Push tag to git
    image: codefresh/cli
    commands:
    - git remote rm origin
    - git remote add origin https://olegsu:${{GITHUB_TOKEN}}@github.com/open-integration/core.git
    - git tag v${{VERSION}}
    - git push --tags
    when:
      branch:
        only:
        - master
      steps:
      - name: test
        on:
        - success
      - name: test-fmt
        on:
        - success
      - name: version
        on:
        - success
      condition:
        all:
          NewVersion: '"${{VERSION}}" != "${{LATEST_VERSION}}"'