version: '1.0'

mode: parallel

stages:
- prepare
- test

steps:
  main_clone:
    stage: prepare
    type: git-clone
    repo: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    git: cf_github
    revision: ${{CF_REVISION}}


  module-download:
    stage: prepare
    image: openintegration/testing
    commands:
    - go mod download
    when: &clone
      steps:
      - name: main_clone
        on:
        - success

  security: &common
    image: openintegration/testing
    stage: test
    commands:
    - snyk auth ${{SNYK_TOKEN}}
    - snyk monitor
    when:
      steps:
      - name: module-download
        on:
        - success
          
  test:
    <<: *common
    environment:
    - VCS_COMMIT_ID=${{CF_REVISION}}
    - VCS_BRANCH_NAME=${{CF_BRANCH}}
    - VCS_SLUG=open-integration/core
    - CI_BUILD_ID=${{CF_BUILD_ID}}
    - CI_BUILD_URL=${{CF_BUILD_URL}}
    commands:
    - make test
    - curl -o codecov.sh https://codecov.io/bash && chmod +x codecov.sh
    - ./codecov.sh -e VCS_COMMIT_ID,VCS_BRANCH_NAME,VCS_SLUG,CI_BUILD_ID,CI_BUILD_URL

  test-fmt:
    <<: *common
    stage: test
    commands:
    - make test-fmt

  spellcheck:
    <<: *common
    stage: test
    title: Spell Check
    commands:
      - make spellcheck

  lint:
    <<: *common
    stage: test
    title: Run Go Lint
    commands:
      - make lint

  code-security-scan:
    <<: *common
    stage: test
    title: Scan code security issues
    commands:
      - make security-check
